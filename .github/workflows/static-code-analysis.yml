name: Static Code Analysis

on:
  workflow_call:
    inputs:
      coverage_artifact:
        description: 'The coverage report artifact file name or path to download from the workflow container.'
        required: true
        type: string

jobs:
  static_code_analysis:
        runs-on: ubuntu-latest
        env:
          COVERAGE_REPORT: ${{ inputs.coverage_artifact }}
        steps:
        # Checkouts the github repository
        - uses: actions/checkout@v2
          with:
            fetch-depth: 0
        # Downloads the coverage report artifact
        - uses: actions/download-artifact@v3
          with:
            name: ${{ inputs.coverage_artifact }}
        # If artifact is `coverage.json | .resultset.json ` update file
        # bug in SonarQube when parsing ruby coverage reports need to change the path location
        # in the file or else no coverage data will display in SonarQube
        - name: Parse file
          if: inputs.coverage_artifact == 'coverage.json' || inputs.coverage_artifact == '.resultset.json'
          run: sed -i 's@'$GITHUB_WORKSPACE'@/github/workspace/@g' $COVERAGE_REPORT
        # Performs the SonarQube static code analysis scan
        - uses: sonarsource/sonarqube-scan-action@master
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_DEV }} # Set as an organization secret
            SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }} # Set as an organization secret